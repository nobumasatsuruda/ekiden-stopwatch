<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é§…ä¼è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ  Pro (Complete Edition)</title>
    <style>
        :root {
            --primary-color: #333;
            --accent-color: #0056b3;
            --bg-color: #f4f4f9;
            --card-bg: #fff;
            --kuriage-color: #d9534f;
            --record-new-color: #e60000;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        h1, h2, h3 { text-align: center; margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
        .hidden { display: none !important; }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-outline { background-color: transparent; border: 2px solid #666; color: #666; }

        /* é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ */
        #toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #toast-notification.show { opacity: 1; }

        /* è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚¨ãƒªã‚¢ */
        .file-controls {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed #999;
        }

        /* å¤§ä¼šæƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .meta-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .meta-info-grid label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .meta-info-grid input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* è¨­å®šç”»é¢ */
        #setup-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .team-setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .team-input-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background: #fafafa;
        }
        
        /* è¨˜éŒ²å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .records-setup-area {
            background: #fff8e1;
            border: 1px solid #ffe0b2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .records-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .record-input-group {
            background: rgba(255,255,255,0.7);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªé¸æ‰‹ãƒªã‚¹ãƒˆ */
        .runner-sort-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        .runner-sort-item {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .drag-handle {
            cursor: move;
            padding: 0 10px;
            font-size: 1.2em;
            color: #888;
            user-select: none;
        }
        .runner-section-num {
            font-weight: bold;
            margin-right: 8px;
            width: 30px;
            text-align: center;
            font-size: 0.8em;
            background: #eee;
            border-radius: 3px;
        }
        .runner-name-input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* ãƒ¬ãƒ¼ã‚¹ç”»é¢ */
        #timer-display {
            font-size: 4em;
            font-family: 'Courier New', monospace;
            text-align: center;
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .race-grid {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 20px;
            min-height: 400px;
        }

        .team-column {
            flex: 0 0 240px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 10px solid #ccc;
            position: relative;
        }

        /* é †ä½è¡¨ç¤ºãƒãƒƒã‚¸ */
        .rank-badge {
            background: #333;
            color: #fff;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: normal;
            vertical-align: middle;
        }

        .team-header { padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: center; align-items: center; }
        .current-runner { padding: 15px; text-align: center; background: #eef; flex-shrink: 0; }
        .current-runner h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #666; }
        .current-runner p { margin: 0; font-size: 1.2em; font-weight: bold; }

        .btn-tasuki { width: 100%; padding: 15px; font-size: 1.2em; margin:0; }
        
        .history-list {
            flex-grow: 1;
            padding: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            overflow-y: auto;
            background: #fff;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }
        .history-item span:first-child { font-weight: bold; }
        .kuriage-mark { color: red; font-weight: bold; }

        /* ç¹°ã‚Šä¸Šã’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        #kuriage-menu {
            background: #fff3cd; 
            padding: 15px; 
            text-align: center; 
            border: 2px solid #ffeeba; 
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .kuriage-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .kuriage-block {
            background: rgba(255,255,255,0.6);
            padding: 10px;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }

        /* é…ã‚Œèµ°è€…ã‚¨ãƒªã‚¢ */
        #straggler-zone {
            margin-top: 30px;
            padding: 20px;
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 8px;
        }
        .straggler-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .straggler-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 5px solid #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            width: 200px;
            text-align: center;
        }

        /* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #f2f2f2; }
        
        /* ç·¨é›†å¯èƒ½ãªã‚»ãƒ« */
        td[contenteditable="true"] {
            background-color: #fffff0;
            cursor: text;
        }
        td[contenteditable="true"]:focus {
            background-color: #fff;
            outline: 2px solid var(--accent-color);
            z-index: 10;
        }

        .colored-rank {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .new-record-badge {
            color: var(--record-new-color);
            font-weight: bold;
            font-size: 0.8em;
            margin-left: 4px;
            display: inline-block;
            animation: flash 2s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* --- è¨˜éŒ²è¨¼ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ --- */
        #print-preview-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }
        #print-preview-content {
            background: #555;
            min-height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .preview-controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2001;
            display: flex;
            gap: 10px;
        }

        /* è¨˜éŒ²è¨¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆA4ç¸¦ï¼‰ */
        .certificate-page {
            width: 210mm; 
            height: 297mm;
            background: white;
            position: relative;
            box-sizing: border-box;
            padding: 10mm 15mm; 
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: "Serif", "Mincho", "Hiragino Mincho ProN", serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            page-break-after: always;
            page-break-inside: avoid;
        }

        .cert-frame {
            position: absolute;
            top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
            border: 2px solid #b8860b;
            outline: 4px double #b8860b;
            outline-offset: 4px;
            z-index: 0;
            pointer-events: none;
        }

        .cert-layer { z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .cert-title { 
            font-size: 5em; 
            margin-top: 15mm;
            margin-bottom: 10mm; 
            letter-spacing: 0.3em; 
            font-weight: bold; 
            line-height: 1.0;
        }

        /* åå‰ãƒ»ãƒãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .cert-header-area {
            width: 90%;
            margin-bottom: 10mm;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* å·¦å¯„ã› */
        }

        .cert-team-info {
            font-size: 2.2em; /* ãƒãƒ¼ãƒ åã‚µã‚¤ã‚º */
            font-weight: bold;
            margin-bottom: 5px;
            width: 100%;
            text-align: left;
            margin-left: 20px;
        }

        .cert-runner-line {
            width: 100%;
            text-align: center;
            border-bottom: 1px solid transparent; 
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 20px;
            overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
        }

        .cert-section-info {
            font-size: 2.2em; /* ãƒãƒ¼ãƒ åã¨åŒã˜ã‚µã‚¤ã‚º */
            font-weight: bold;
            white-space: nowrap; /* æ”¹è¡Œç¦æ­¢ */
        }

        .cert-runner-name {
            font-size: 4.2em; 
            font-weight: bold;
            white-space: nowrap; /* æ”¹è¡Œç¦æ­¢ */
        }
        
        /* è¨˜éŒ² */
        .cert-record-area {
            font-size: 2.5em; 
            margin-top: 5mm;
            margin-bottom: 10mm;
            text-align: center;
            font-weight: bold;
        }
        
        .cert-new-record-mark {
            color: var(--record-new-color);
            font-size: 0.6em;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* æœ¬æ–‡ */
        .cert-text { 
            font-size: 2em; 
            margin: 0 5mm; 
            line-height: 1.8; 
            text-align: justify; 
            width: 90%;
            letter-spacing: 0.05em;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .cert-footer { 
            width: 90%; 
            margin-top: auto; 
            margin-bottom: 15mm;
            display: flex; 
            flex-direction: column; 
            align-items: center; /* ä¸­å¤®æƒãˆ */
            gap: 15px;
        }
        
        .cert-date { 
            width: 100%;
            font-size: 1.6em; 
            text-align: left; /* å·¦å¯„ã› */
            margin-bottom: 10px;
        }

        .cert-org {
            font-size: 2.0em;
            font-weight: bold;
            text-align: center;
        }

        .cert-signer { 
            text-align: center; 
            font-size: 2.2em; 
        }
        .cert-signer-job { font-size: 0.6em; margin-right: 10px; }
        .cert-signer-name { font-weight: bold; letter-spacing: 0.1em; }

        /* =========================================
           å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ1ãƒšãƒ¼ã‚¸åã‚ä¿®æ­£ç‰ˆï¼‰
           ========================================= */
        @media print {
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }

            .btn, .file-controls, .preview-controls, #toast-notification, .container { 
                display: none !important; 
            }

            body.print-mode {
                background: white !important;
            }

            body.print-mode #print-preview-modal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: transparent !important;
                overflow: visible !important;
                z-index: auto !important;
            }

            body.print-mode #print-preview-content {
                display: block !important;
                background: transparent !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                width: 100% !important;
            }
            
            body.print-mode #certificates-wrapper {
                display: block !important;
                width: 100% !important;
            }

            body.print-mode .certificate-page {
                box-shadow: none !important;
                margin: 0 auto !important;
                /* ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ä½™ç™½ã‚’è€ƒæ…®ã—297mmã‚ˆã‚Šå°‘ã—å°ã•ãè¨­å®š */
                height: 290mm !important; 
                width: 100% !important;
                
                page-break-after: always !important;
                break-after: page !important;
                page-break-inside: avoid !important;
                
                overflow: hidden !important;
                background: white !important;
                position: relative !important;
            }

            body.print-mode .certificate-page:last-child {
                page-break-after: auto !important;
                break-after: auto !important;
            }
            
            body:not(.print-mode) #print-preview-modal { display: none !important; }
            body:not(.print-mode) .container { width: 100%; display: block !important; }
            
            @page {
                size: A4 portrait;
                margin: 0; 
            }
        }

    </style>
</head>
<body>

<div id="toast-notification">é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

<div class="container">
    <h1>ğŸ† é§…ä¼è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ  Pro</h1>

    <div id="setup-panel">
        <div class="file-controls">
            <h3>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div style="margin-bottom:10px;">
                <strong>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                <button class="btn btn-outline" onclick="downloadSettings()">è¨­å®šã‚’ä¿å­˜</button>
                <label class="btn btn-primary" style="display:inline-block; margin:5px;">
                    è¨­å®šã‚’èª­è¾¼
                    <input type="file" id="file-input" accept=".json" style="display:none" onchange="loadSettings(this)">
                </label>
            </div>
            <div style="border-top:1px dashed #ccc; padding-top:10px;">
                <strong>çµæœãƒ‡ãƒ¼ã‚¿:</strong>
                <label class="btn btn-warning" style="display:inline-block; margin:5px;">
                    çµæœCSVã‚’èª­è¾¼ (å¾©å…ƒ)
                    <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="loadResultCSV(this)">
                </label>
            </div>
        </div>

        <h2>å¤§ä¼šåŸºæœ¬è¨­å®š</h2>
        <div class="meta-info-grid">
            <div><label>å¤§ä¼šå</label><input type="text" id="meta-title" value="æ ¡å†…é§…ä¼å¤§ä¼š"></div>
            <div><label>é–‹å‚¬æ—¥æ™‚</label><input type="datetime-local" id="meta-date"></div>
            <div><label>ä¸»å‚¬å­¦æ ¡ãƒ»å›£ä½“å</label><input type="text" id="meta-org" value="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡ä¸­å­¦æ ¡"></div>
            <div><label>ä¸»å‚¬è€…å½¹è·</label><input type="text" id="meta-job" value="æ ¡é•·"></div>
            <div><label>ä¸»å‚¬è€…æ°å</label><input type="text" id="meta-rep" value="ã€‡ã€‡ ã€‡ã€‡"></div>
        </div>

        <div style="text-align:center; margin-bottom:15px; padding: 15px; background: #eee; border-radius:8px;">
            <label>åŒºé–“æ•°: <input type="number" id="section-count" value="5" min="1" max="20" style="width: 50px;"></label>
            <label style="margin-left: 20px;">ãƒãƒ¼ãƒ æ•°: <input type="number" id="team-count" value="3" min="1" max="20" style="width: 50px;"></label>
            <button class="btn btn-primary" onclick="generateSetupGrid()">ãƒãƒ¼ãƒ ãƒ»èµ°è€…å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ</button>
            <p style="font-size:0.8em; color:#666;">â€»ç”Ÿæˆå¾Œã€é¸æ‰‹ã®é †ç•ªã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§å…¥ã‚Œæ›¿ãˆå¯èƒ½ã§ã™ã€‚</p>
        </div>
        
        <div id="distance-setup" class="hidden" style="text-align:center; margin-bottom:15px;">
            <h3>åŒºé–“è·é›¢è¨­å®š (km)</h3>
            <div id="distance-inputs" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;"></div>
        </div>

        <div id="records-setup" class="hidden records-setup-area">
            <h3>éå»ã®å¤§ä¼šè¨˜éŒ² (ç›®æ¨™ã‚¿ã‚¤ãƒ è¨­å®š)</h3>
            <p style="font-size:0.85em; color:#666; margin-top:-5px;">â€»å…¥åŠ›ã™ã‚‹ã¨ã€Œå¤§ä¼šæ–°ã€ã€ŒåŒºé–“æ–°ã€ã®åˆ¤å®šãŒè¡Œã‚ã‚Œã¾ã™</p>
            <div class="records-grid" id="records-inputs"></div>
        </div>

        <div id="teams-setup" class="team-setup-grid"></div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-success" id="start-setup-btn" onclick="initializeRace()" disabled>è¨­å®šå®Œäº†ãƒ»ãƒ¬ãƒ¼ã‚¹ç”»é¢ã¸</button>
        </div>
    </div>

    <div id="race-panel" class="hidden">
        <h2 id="race-title-display"></h2>
        <div id="timer-display">00:00.00</div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <button class="btn btn-success" id="btn-start" onclick="startTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆ (å·ç ²)</button>
            <button class="btn btn-warning" id="btn-kuriage" onclick="toggleKuriageMenu()">ç¹°ã‚Šä¸Šã’å‡¦ç†...</button>
            <button class="btn btn-primary" onclick="finishRace()">å…¨è¨ˆæ¸¬çµ‚äº†ãƒ»çµæœå‡ºåŠ›</button>
        </div>

        <div id="kuriage-menu" class="hidden">
            <h3 style="color:var(--kuriage-color)">âš ï¸ ç¹°ã‚Šä¸Šã’ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†</h3>
            <div class="kuriage-options">
                <div class="kuriage-block">
                    <h4>å…¨ãƒãƒ¼ãƒ ä¸€æ–‰</h4>
                    <p style="font-size:0.9em; margin-bottom:5px;">ç¾åœ¨èµ°è¡Œä¸­ã®<strong>å…¨ãƒãƒ¼ãƒ </strong>ã‚’ç¹°ã‚Šä¸Šã’ã¾ã™</p>
                    <button class="btn btn-danger" onclick="executeKuriage('all')">ä¸€æ–‰ç¹°ã‚Šä¸Šã’å®Ÿè¡Œ</button>
                </div>
                <div class="kuriage-block">
                    <h4>é…å»¶ãƒãƒ¼ãƒ ã®ã¿</h4>
                    <p style="font-size:0.9em; margin-bottom:5px;"><strong>å¾Œæ–¹ãƒãƒ¼ãƒ ã®ã¿</strong>ã‚’ç¹°ã‚Šä¸Šã’ã¾ã™</p>
                    <button class="btn btn-warning" onclick="executeKuriage('delayed')">é…å»¶ãƒãƒ¼ãƒ ã®ã¿å®Ÿè¡Œ</button>
                </div>
            </div>
            <button class="btn" style="margin-top:15px;" onclick="toggleKuriageMenu()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div class="race-grid" id="race-grid"></div>

        <div id="straggler-zone" class="hidden">
            <h3 style="margin-top:0;">â³ é…ã‚Œèµ°è€… åˆ°ç€å¾…ã¡</h3>
            <div id="straggler-list" class="straggler-grid"></div>
        </div>
    </div>

    <div id="result-panel" class="hidden" style="background: white; padding: 20px; margin-top: 20px;">
        <h2>ãƒ¬ãƒ¼ã‚¹çµæœï¼ˆç·¨é›†å¯èƒ½ï¼‰</h2>
        <p style="text-align:center; font-size:0.9em; color:#666;">
            â€»è¡¨ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿®æ­£ã§ãã¾ã™ã€‚ä¿®æ­£å¾Œã¯è‡ªå‹•ã§å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚<br>
            â€»å‚™è€ƒæ¬„ã«ã€ŒOPã€ã€Œå‚è€ƒã€ã€Œä»£ç†ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ãã®åŒºé–“ã¯åŒºé–“é †ä½ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ã€‚
        </p>
        <div style="text-align:center;">
            <button class="btn btn-success" onclick="downloadExcel()">Excel(CSV)ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-warning" onclick="openCertificatePreview()">ğŸ–¨ï¸ è¨˜éŒ²è¨¼ã‚’ç™ºè¡Œ (ç·¨é›†ãƒ»å°åˆ·)</button>
            <button class="btn" onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
        </div>

        <h3 style="margin-top:20px; border-bottom:2px solid #ccc;">ç·åˆé †ä½</h3>
        <div style="overflow-x: auto;">
            <table id="result-table"></table>
        </div>

        <h3 style="margin-top:40px; border-bottom:2px solid #ccc;">åŒºé–“è³ãƒ»åŒºé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="section-ranking-container"></div>
    </div>
</div>

<div id="print-preview-modal">
    <div id="print-preview-content">
        <div class="preview-controls">
            <span style="align-self:center; font-weight:bold;">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            <button class="btn btn-success" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ã™ã‚‹</button>
            <button class="btn btn-danger" onclick="closeCertificatePreview()">é–‰ã˜ã‚‹</button>
        </div>
        <div id="certificates-wrapper"></div>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let config = {
        meta: { title: "", date: "", org: "", job: "", rep: "" },
        sectionCount: 5,
        teamCount: 3,
        distances: [],
        records: { total: null, sections: [] } 
    };
    
    let teams = []; 
    let pendingStragglers = []; 

    let raceState = {
        startTime: null,
        timerId: null, // requestAnimationFrame ID
        isRunning: false
    };

    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('meta-date').value = now.toISOString().slice(0,16);
    });

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function pad(n) { return n < 10 ? '0'+n : n; }
    
    // å¸¸ã«2æ¡ã®å°æ•°éƒ¨ (1/100ç§’) ã‚’è¡¨ç¤º
    function formatTimeDigit(ms) {
        if(!ms && ms !== 0) return "-";
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centis = Math.floor((ms % 1000) / 10);
        
        if (hours > 0) return `${hours}:${pad(minutes)}:${pad(seconds)}.${pad(centis)}`;
        return `${pad(minutes)}:${pad(seconds)}.${pad(centis)}`;
    }

    // è¨˜éŒ²è¨¼ç”¨
    function formatTime(ms) {
        if(!ms && ms !== 0) return "-";
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centis = Math.floor((ms % 1000) / 10);
        
        if (hours > 0) return `${hours}æ™‚é–“${pad(minutes)}åˆ†${pad(seconds)}ç§’${pad(centis)}`;
        return `${minutes}åˆ†${pad(seconds)}ç§’${pad(centis)}`;
    }

    // ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—è§£æ (å³å¯†)
    function parseTimeStr(str) {
        if (!str || str === "-" || str === "") return 0;
        str = str.replace(/[ï¼-ï¼™ï¼šï¼]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).trim();
        const parts = str.split(':');
        let h = 0, m = 0, s = 0, ms = 0;

        if (parts.length > 0) {
            let secStr = parts[parts.length - 1];
            if (secStr.includes('.')) {
                const secParts = secStr.split('.');
                s = parseInt(secParts[0], 10);
                let decimalStr = secParts[1];
                if (decimalStr.length === 1) ms = parseInt(decimalStr) * 100;
                else if (decimalStr.length === 2) ms = parseInt(decimalStr) * 10;
                else if (decimalStr.length >= 3) ms = parseInt(decimalStr.slice(0, 3));
            } else {
                s = parseInt(secStr, 10);
            }
        }
        if (parts.length > 1) m = parseInt(parts[parts.length - 2], 10);
        if (parts.length > 2) h = parseInt(parts[parts.length - 3], 10);

        if (isNaN(h)) h = 0;
        if (isNaN(m)) m = 0;
        if (isNaN(s)) s = 0;
        if (isNaN(ms)) ms = 0;

        return (h * 3600000) + (m * 60000) + (s * 1000) + ms;
    }
    
    function formatTimeForInput(ms) {
        if(!ms && ms !== 0) return "";
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        if (hours > 0) return `${hours}:${pad(minutes)}:${pad(seconds)}`;
        return `${pad(minutes)}:${pad(seconds)}`;
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
        return color;
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // --- è¨­å®šç”»é¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    function generateSetupGrid() {
        const sc = parseInt(document.getElementById('section-count').value);
        const tc = parseInt(document.getElementById('team-count').value);
        if(sc < 1 || tc < 1) return alert("æ•°å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");

        config.sectionCount = sc;
        config.teamCount = tc;

        const distContainer = document.getElementById('distance-inputs');
        distContainer.innerHTML = '';
        document.getElementById('distance-setup').classList.remove('hidden');
        for(let i=1; i<=sc; i++){
            let val = config.distances[i-1] || 3;
            distContainer.innerHTML += `<div>${i}åŒº: <input type="number" class="dist-val" style="width:50px" value="${val}">km</div>`;
        }

        const recordsContainer = document.getElementById('records-inputs');
        recordsContainer.innerHTML = '';
        document.getElementById('records-setup').classList.remove('hidden');
        
        const totalVal = formatTimeForInput(config.records.total);
        recordsContainer.innerHTML += `
            <div class="record-input-group">
                <label>ç·åˆè¨˜éŒ²</label>
                <input type="text" id="record-total" value="${totalVal}" placeholder="1:05:30" style="width:80px; text-align:center;">
            </div>`;
        
        for(let i=1; i<=sc; i++){
            const secVal = formatTimeForInput(config.records.sections[i-1]);
            recordsContainer.innerHTML += `
                <div class="record-input-group">
                    <label>${i}åŒº</label>
                    <input type="text" class="record-sec-val" value="${secVal}" placeholder="09:45" style="width:60px; text-align:center;">
                </div>`;
        }

        const teamsContainer = document.getElementById('teams-setup');
        teamsContainer.innerHTML = '';
        
        for(let i=1; i<=tc; i++){
            let currentTeam = teams[i-1] || { name: `ãƒãƒ¼ãƒ ${i}`, color: getRandomColor(), runners: [] };
            let runnerListHtml = '';
            for(let s=1; s<=sc; s++){
                let rName = currentTeam.runners[s-1] || "";
                runnerListHtml += `
                    <li class="runner-sort-item" draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <span class="drag-handle">â‰¡</span>
                        <span class="runner-section-num">${s}åŒº</span>
                        <input type="text" class="runner-name-input" value="${rName}" placeholder="èµ°è€…å">
                    </li>`;
            }

            const html = `
            <div class="team-input-card" id="team-setup-${i}">
                <h3 style="margin:5px 0;">Team ${i}</h3>
                <label>ãƒãƒ¼ãƒ å: <input type="text" class="team-name" value="${currentTeam.name}"></label><br>
                <label>ã‚¿ã‚¹ã‚­è‰²: <input type="color" class="team-color" value="${currentTeam.color}"></label>
                <div style="margin-top:10px;">
                    <strong>èµ°è€…é †:</strong>
                    <ul class="runner-sort-list" id="runner-list-${i}">
                        ${runnerListHtml}
                    </ul>
                </div>
            </div>`;
            teamsContainer.insertAdjacentHTML('beforeend', html);
        }

        document.getElementById('start-setup-btn').disabled = false;
        document.getElementById('start-setup-btn').textContent = "è¨­å®šå®Œäº†ãƒ»ãƒ¬ãƒ¼ã‚¹ç”»é¢ã¸";
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—åˆ¶å¾¡ ---
    let draggedItem = null;
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) {
        draggedItem = ev.target.closest('li');
        ev.dataTransfer.effectAllowed = "move";
    }
    function drop(ev) {
        ev.preventDefault();
        const targetItem = ev.target.closest('li');
        if (draggedItem && targetItem && draggedItem !== targetItem && draggedItem.parentNode === targetItem.parentNode) {
            const list = draggedItem.parentNode;
            const items = Array.from(list.children);
            const fromIndex = items.indexOf(draggedItem);
            const toIndex = items.indexOf(targetItem);
            if (fromIndex < toIndex) {
                list.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                list.insertBefore(draggedItem, targetItem);
            }
            updateSectionLabels(list);
        }
    }
    function updateSectionLabels(listElement) {
        const items = listElement.querySelectorAll('.runner-sort-item');
        items.forEach((item, index) => {
            item.querySelector('.runner-section-num').textContent = `${index + 1}åŒº`;
        });
    }

    // --- è¨­å®šä¿å­˜ãƒ»èª­è¾¼ ---
    function getSettingsObject() {
        let dists = [];
        document.querySelectorAll('.dist-val').forEach(el => dists.push(el.value));
        
        let secRecords = [];
        document.querySelectorAll('.record-sec-val').forEach(el => secRecords.push(parseTimeStr(el.value)));
        let totalRecord = parseTimeStr(document.getElementById('record-total')?.value);

        let currentTeams = [];
        const container = document.getElementById('teams-setup');
        if(container.children.length === 0) return null;

        for(let i=1; i<=config.teamCount; i++){
            const card = document.getElementById(`team-setup-${i}`);
            const name = card.querySelector('.team-name').value;
            const color = card.querySelector('.team-color').value;
            const runners = [];
            card.querySelectorAll('.runner-name-input').forEach(inp => runners.push(inp.value));
            currentTeams.push({ name, color, runners });
        }

        const meta = {
            title: document.getElementById('meta-title').value,
            date: document.getElementById('meta-date').value,
            org: document.getElementById('meta-org').value,
            job: document.getElementById('meta-job').value,
            rep: document.getElementById('meta-rep').value
        };

        return { 
            meta: meta,
            sectionCount: config.sectionCount, 
            teamCount: config.teamCount, 
            distances: dists, 
            records: { total: totalRecord, sections: secRecords },
            teamsData: currentTeams 
        };
    }

    function downloadSettings() {
        const data = getSettingsObject();
        if(!data) return alert("å…ˆã«å…¥åŠ›æ¬„ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„");
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "ekiden_settings.json";
        link.click();
    }

    function loadSettings(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                document.getElementById('section-count').value = data.sectionCount;
                document.getElementById('team-count').value = data.teamCount;
                if(data.meta) {
                    document.getElementById('meta-title').value = data.meta.title || "";
                    document.getElementById('meta-date').value = data.meta.date || "";
                    document.getElementById('meta-org').value = data.meta.org || "";
                    document.getElementById('meta-job').value = data.meta.job || "";
                    document.getElementById('meta-rep').value = data.meta.rep || "";
                }
                config.sectionCount = data.sectionCount;
                config.teamCount = data.teamCount;
                config.distances = data.distances;
                config.records = data.records || { total: null, sections: [] }; 
                teams = data.teamsData.map(t => ({ name: t.name, color: t.color, runners: t.runners }));
                generateSetupGrid();
                showToast("è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            } catch(err) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err); }
        };
        reader.readAsText(file);
    }

    // --- CSVèª­ã¿è¾¼ã¿ (å¾©å…ƒãƒ»ã‚«ãƒ©ãƒ¼å¯¾å¿œ) ---
    function loadResultCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsText(file, 'UTF-8');

        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== "");

                const rows = lines.map(line => {
                    let res = [];
                    let current = '';
                    let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const c = line[i];
                        if (c === '"') { inQuote = !inQuote; }
                        else if (c === ',' && !inQuote) {
                            res.push(current.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                            current = '';
                            continue;
                        }
                        current += c;
                    }
                    res.push(current.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    return res;
                });

                if (rows.length < 2) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

                const header = rows[0];
                const colCount = header.length;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ¤å®šï¼šé †ä½(0), ãƒãƒ¼ãƒ å(1), è‰²(2)?, ç·åˆã‚¿ã‚¤ãƒ ...
                // æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯è‰²ãŒã‚ã‚‹ãŸã‚ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒå¤‰ã‚ã‚‹
                let hasColorCol = header[2] === "ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼" || (rows[1] && rows[1][2] && rows[1][2].startsWith('#'));
                let offset = hasColorCol ? 4 : 3;

                let sc = Math.floor((colCount - offset) / 4);
                let scFromText = 0;
                header.forEach(h => { if (h && h.match(/\d+åŒºèµ°è€…/)) scFromText++; });
                if (scFromText > 0) sc = scFromText;

                config.sectionCount = sc;
                config.teamCount = rows.length - 1;
                document.getElementById('section-count').value = sc;
                document.getElementById('team-count').value = config.teamCount;

                teams = [];
                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i];
                    if(cols.length < 3) continue;

                    const teamName = cols[1];
                    const teamColor = hasColorCol ? cols[2] : getRandomColor();
                    
                    const runners = [];
                    const splits = [];
                    let calculatedTotalTime = 0; 

                    for (let s = 1; s <= sc; s++) {
                        const baseIdx = offset + (s - 1) * 4;
                        if (baseIdx >= cols.length) break;

                        const rName = cols[baseIdx] || "";
                        const netTimeStr = cols[baseIdx + 1];
                        const note = cols[baseIdx + 3] || "";

                        runners.push(rName);

                        if (netTimeStr && netTimeStr !== "-" && netTimeStr !== "") {
                            const parsedNetTime = parseTimeStr(netTimeStr);
                            if (parsedNetTime > 0) calculatedTotalTime += parsedNetTime;

                            splits.push({
                                section: s,
                                runner: rName,
                                netTime: parsedNetTime,
                                finishTime: calculatedTotalTime, 
                                isKuriage: note.includes("ç¹°ã‚Šä¸Šã’"),
                                kuriageType: note.includes("ä¸€æ–‰") ? 'all' : (note.includes("é…å»¶") ? 'delayed' : null),
                                note: note // å‚™è€ƒã‚’ä¿æŒ
                            });
                        }
                    }

                    teams.push({
                        id: i - 1,
                        name: teamName,
                        color: teamColor,
                        runners: runners,
                        currentSection: sc, 
                        splits: splits,
                        status: 'finished',
                        finishTime: calculatedTotalTime
                    });
                }

                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('race-panel').classList.add('hidden'); 
                document.getElementById('result-panel').classList.remove('hidden');
                
                const meta = {
                    title: document.getElementById('meta-title').value,
                    date: document.getElementById('meta-date').value,
                    org: document.getElementById('meta-org').value,
                    job: document.getElementById('meta-job').value,
                    rep: document.getElementById('meta-rep').value
                };
                config.meta = meta;

                generateResultTable();
                generateSectionRanking();
                showToast("çµæœCSVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");

            } catch (err) {
                console.error(err);
                alert("CSVèª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err);
            }
        };
    }


    // --- ãƒ¬ãƒ¼ã‚¹åˆæœŸåŒ– ---
    function initializeRace() {
        const settings = getSettingsObject();
        config.meta = settings.meta;
        config.distances = settings.distances;
        config.records = settings.records;
        
        teams = settings.teamsData.map((t, i) => ({
            id: i,
            name: t.name,
            color: t.color,
            runners: t.runners, 
            currentSection: 0, 
            splits: [], 
            status: 'ready'
        }));

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('race-panel').classList.remove('hidden');
        document.getElementById('race-title-display').textContent = config.meta.title; 
        renderRaceGrid();
        refreshRankDisplay(); 
    }

    // --- ãƒ¬ãƒ¼ã‚¹ç”»é¢æç”» ---
    function renderRaceGrid() {
        const grid = document.getElementById('race-grid');
        grid.innerHTML = '';

        teams.forEach((team, index) => {
            let currentRunnerName = "å¾…æ©Ÿä¸­";
            if (team.status === 'running') currentRunnerName = team.runners[team.currentSection] || "æœªç™»éŒ²";
            else if (team.status === 'finished') currentRunnerName = "ã‚´ãƒ¼ãƒ«";

            let btnDisabled = !raceState.isRunning || team.status === 'finished';
            let btnText = "ã‚¿ã‚¹ã‚­ã‚’æ¸¡ã™";
            if (team.currentSection === config.sectionCount - 1) btnText = "ã‚´ãƒ¼ãƒ«ï¼";
            if (team.status === 'finished') { btnText = "å®Œèµ°"; btnDisabled = true; }

            const div = document.createElement('div');
            div.className = 'team-column';
            div.style.borderTopColor = team.color;
            div.innerHTML = `
                <div class="team-header" style="background-color:${team.color}22">
                    <span style="font-size:1.1em">${team.name}</span>
                    <span id="rank-badge-${index}" class="rank-badge">-</span>
                </div>
                <div class="current-runner" id="runner-box-${index}">
                    <h4 class="section-label" id="section-label-${index}">ç¾åœ¨èµ°è¡Œä¸­ (${team.status === 'finished' ? '-' : team.currentSection + 1}åŒº)</h4>
                    <p id="runner-name-${index}">${currentRunnerName}</p>
                </div>
                <div style="padding:10px;">
                    <button class="btn btn-primary btn-tasuki" 
                        id="btn-tasuki-${index}" 
                        onclick="passTasuki(${index})" 
                        ${btnDisabled ? 'disabled' : ''}
                        style="background-color:${team.color}; color: white; text-shadow:0 1px 2px rgba(0,0,0,0.5);">
                        ${btnText}
                    </button>
                </div>
                <div class="history-list" id="history-${index}"></div>
            `;
            grid.appendChild(div);
        });
    }

    function renderStragglers() {
        const zone = document.getElementById('straggler-zone');
        const list = document.getElementById('straggler-list');
        list.innerHTML = '';
        if (pendingStragglers.length === 0) { zone.classList.add('hidden'); return; }
        zone.classList.remove('hidden');
        pendingStragglers.forEach((ps, idx) => {
            const team = teams[ps.teamId];
            const div = document.createElement('div');
            div.className = 'straggler-card';
            div.style.borderLeftColor = team.color;
            div.innerHTML = `
                <strong>${team.name}</strong><br>
                <small>${ps.section}åŒº</small> <span style="font-weight:bold">${ps.runnerName}</span><br>
                <button class="btn btn-warning btn-sm" style="margin-top:5px; width:100%" 
                    onclick="stragglerArrive(${idx})">åˆ°ç€ (è¨ˆæ¸¬)</button>
            `;
            list.appendChild(div);
        });
    }

    // --- é †ä½è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (è»½é‡åŒ–) ---
    function refreshRankDisplay() {
        if (!raceState.isRunning) {
            if(teams.every(t => t.status === 'ready')){
               teams.forEach((t, i) => {
                   const el = document.getElementById(`rank-badge-${i}`);
                   if(el) el.textContent = '-';
               });
               return;
            }
        }

        // å¿…è¦ãªæƒ…å ±ã ã‘æŠ½å‡ºã—ã¦ã‚½ãƒ¼ãƒˆ
        let sortable = teams.map((t, index) => ({
            index: index,
            completed: t.status === 'finished' ? config.sectionCount : t.currentSection,
            finishTime: t.finishTime || Number.MAX_SAFE_INTEGER,
            lastSplitTime: (t.splits.length > 0) ? t.splits[t.splits.length - 1].finishTime : 0
        }));

        sortable.sort((a, b) => {
            if (a.completed !== b.completed) return b.completed - a.completed;
            if (a.completed === config.sectionCount) return a.finishTime - b.finishTime;
            return a.lastSplitTime - b.lastSplitTime;
        });

        // DOMæ“ä½œã‚’æœ€å°é™ã«
        sortable.forEach((item, rank) => {
            const el = document.getElementById(`rank-badge-${item.index}`);
            if (el) el.textContent = `No.${rank + 1}`;
        });
    }

    // --- è¨ˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ©ã‚°è§£æ¶ˆ: requestAnimationFrame) ---
    function startTimer() {
        if(raceState.isRunning) return;
        raceState.startTime = Date.now();
        raceState.isRunning = true;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-start').textContent = "ãƒ¬ãƒ¼ã‚¹é€²è¡Œä¸­";
        
        teams.forEach((t, i) => { t.status = 'running'; t.currentSection = 0; updateTeamUI(i); });
        refreshRankDisplay();

        const timerLoop = () => {
            if (!raceState.isRunning) return;
            const diff = Date.now() - raceState.startTime;
            document.getElementById('timer-display').textContent = formatTimeDigit(diff);
            raceState.timerId = requestAnimationFrame(timerLoop);
        };
        raceState.timerId = requestAnimationFrame(timerLoop);
        document.querySelectorAll('.btn-tasuki').forEach(b => b.disabled = false);
    }

    function passTasuki(teamIndex) {
        const team = teams[teamIndex];
        if (team.status === 'finished') return;

        const now = Date.now();
        const finishTimeMs = now - raceState.startTime;
        
        if (team.currentSection === 0) team.sectionStartTime = 0;
        const netTime = finishTimeMs - (team.sectionStartTime || 0);
        
        team.splits.push({
            section: team.currentSection + 1,
            runner: team.runners[team.currentSection],
            startTime: team.sectionStartTime || 0,
            finishTime: finishTimeMs,
            netTime: netTime,
            isKuriage: false,
            kuriageType: null,
            note: ""
        });

        advanceSection(teamIndex, finishTimeMs);
    }

    function advanceSection(teamIndex, nextStartTime) {
        const team = teams[teamIndex];
        if (team.currentSection < config.sectionCount - 1) {
            team.currentSection++;
            team.sectionStartTime = nextStartTime; 
        } else {
            team.status = 'finished';
            team.finishTime = nextStartTime; 
        }
        updateTeamUI(teamIndex);
        // ãƒ©ã‚°é˜²æ­¢: å³åº§ã«å…¨ã‚½ãƒ¼ãƒˆè¨ˆç®—ã›ãšã€å°‘ã—é…å»¶ã•ã›ã‚‹ã‹ã€ã“ã“ã§ã¯å¿…é ˆã®æ›´æ–°ã ã‘ã«ã™ã‚‹
        // ä»Šå›ã¯è»½é‡åŒ–ã—ãŸã®ã§ãã®ã¾ã¾å‘¼ã¶
        refreshRankDisplay(); 
        checkAllFinished();
    }

    function updateTeamUI(index) {
        const team = teams[index];
        const card = document.getElementById('race-grid').children[index];
        
        card.querySelector(`#section-label-${index}`).textContent = 
            team.status === 'finished' ? "ç¾åœ¨èµ°è¡Œä¸­ (-)" : `ç¾åœ¨èµ°è¡Œä¸­ (${team.currentSection + 1}åŒº)`;

        const runnerNameEl = card.querySelector(`#runner-name-${index}`);
        runnerNameEl.textContent = team.status === 'finished' ? "ã‚´ãƒ¼ãƒ«" : (team.runners[team.currentSection] || `èµ°è€…${team.currentSection+1}`);
        runnerNameEl.style.color = team.status === 'finished' ? "red" : "black";

        const historyList = card.querySelector(`#history-${index}`);
        // å…¨å†æç”»ã§ã¯ãªãã€æœ€æ–°ã®ã¿è¿½åŠ ã™ã‚‹æ–¹ãŒè»½ã„ãŒã€ä¿®æ­£ã®è¤‡é›‘ã•ã‚’é¿ã‘ã‚‹ãŸã‚æ–‡å­—åˆ—ç”Ÿæˆã‚’æœ€é©åŒ–
        let html = '';
        for(let i = team.splits.length - 1; i >= 0; i--) {
            const split = team.splits[i];
            let mark = split.isKuriage ? (split.kuriageType === 'all' ? '(ä¸€æ–‰ç¹°)' : '(ç¹°)') : '';
            html += `<div class="history-item">
                <div><span>${split.section}åŒº ${split.runner}</span><span class="kuriage-mark">${mark}</span></div>
                <div style="text-align:right"><small>åŒºé–“:${formatTimeDigit(split.netTime)}</small><br><span>é€šé:${formatTimeDigit(split.finishTime)}</span></div>
            </div>`;
        }
        historyList.innerHTML = html;

        const btn = card.querySelector(`#btn-tasuki-${index}`);
        if(team.status === 'finished') {
            btn.textContent = "å®Œèµ°";
            btn.disabled = true;
        } else if (team.currentSection === config.sectionCount - 1) {
            btn.textContent = "ã‚´ãƒ¼ãƒ«ï¼";
        } else {
            btn.textContent = "ã‚¿ã‚¹ã‚­ã‚’æ¸¡ã™";
        }
    }

    function toggleKuriageMenu() {
        document.getElementById('kuriage-menu').classList.toggle('hidden');
    }

    function executeKuriage(type) {
        if(!raceState.isRunning) return;
        const now = Date.now();
        const currentTimeMs = now - raceState.startTime;
        
        let minSec = 999;
        let maxSec = -1;
        teams.forEach(t => { 
            if(t.status === 'running') {
                if(t.currentSection < minSec) minSec = t.currentSection;
                if(t.currentSection > maxSec) maxSec = t.currentSection;
            } else if (t.status === 'finished') {
                maxSec = config.sectionCount; 
            }
        });

        if(minSec === 999) return showToast("èµ°è¡Œä¸­ã®ãƒãƒ¼ãƒ ãªã—");
        if (type === 'delayed' && minSec >= maxSec) return alert("ç¾åœ¨ã€å…ˆé ­é›†å›£ã‚ˆã‚Šé…ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");

        let count = 0;
        teams.forEach((team, idx) => {
            const isTarget = (type === 'all') 
                             ? (team.status === 'running' && team.currentSection === minSec)
                             : (team.status === 'running' && team.currentSection === minSec && team.currentSection < maxSec);

            if(isTarget) {
                pendingStragglers.push({
                    teamId: idx,
                    section: team.currentSection + 1,
                    runnerName: team.runners[team.currentSection],
                    startTime: team.sectionStartTime || 0,
                    kuriageType: type 
                });

                if (team.currentSection < config.sectionCount - 1) {
                    team.currentSection++;
                    team.sectionStartTime = currentTimeMs; 
                } else {
                    team.status = 'finished';
                    team.finishTime = currentTimeMs; 
                }
                updateTeamUI(idx); 
                count++;
            }
        });

        if (count > 0) {
            refreshRankDisplay(); 
            toggleKuriageMenu();
            renderStragglers();
            showToast(`${count}ãƒãƒ¼ãƒ  ç¹°ã‚Šä¸Šã’ã‚¹ã‚¿ãƒ¼ãƒˆ`);
        }
    }

    function stragglerArrive(psIndex) {
        const ps = pendingStragglers[psIndex];
        const team = teams[ps.teamId];
        const now = Date.now();
        const finishTimeMs = now - raceState.startTime;
        const netTime = finishTimeMs - ps.startTime;

        team.splits.push({
            section: ps.section,
            runner: ps.runnerName,
            startTime: ps.startTime,
            finishTime: finishTimeMs,
            netTime: netTime,
            isKuriage: true,
            kuriageType: ps.kuriageType, 
            note: ""
        });
        team.splits.sort((a,b) => a.section - b.section);
        pendingStragglers.splice(psIndex, 1);
        renderStragglers();
        updateTeamUI(ps.teamId); 
        refreshRankDisplay(); 
        showToast(`${team.name} å‰èµ°è€…ãŒåˆ°ç€ã—ã¾ã—ãŸ`);
    }

    function checkAllFinished() {
        if(teams.every(t => t.status === 'finished') && pendingStragglers.length === 0) {
            cancelAnimationFrame(raceState.timerId);
            document.getElementById('timer-display').style.color = "#fff";
            document.getElementById('timer-display').textContent += " (å…¨çµ‚äº†)";
            showToast("å…¨ãƒãƒ¼ãƒ ã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼");
            finishRace();
        }
    }

    function finishRace() {
        cancelAnimationFrame(raceState.timerId);
        document.getElementById('race-panel').classList.add('hidden');
        document.getElementById('result-panel').classList.remove('hidden');
        generateResultTable();
        generateSectionRanking();
    }

    // --- è¨˜éŒ²åˆ¤å®š ---
    function isNewSectionRecord(sectionIndex, netTime) {
        if (!config.records || !config.records.sections) return false;
        const record = config.records.sections[sectionIndex - 1];
        return (record && netTime < record);
    }
    function isNewTotalRecord(totalTime) {
        if (!config.records || !config.records.total) return false;
        return (totalTime < config.records.total);
    }

    // --- çµæœç·¨é›†ãƒ»å†è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    function updateResultData(teamId, type, section, value) {
        const team = teams.find(t => t.id == teamId);
        if(!team) return;

        if (type === 'name') {
            const split = team.splits.find(s => s.section == section);
            if(split) split.runner = value;
        } 
        else if (type === 'time') {
            const split = team.splits.find(s => s.section == section);
            if(split) {
                split.netTime = parseTimeStr(value);
                recalculateTeamTimes(team);
            }
        }
        else if (type === 'note') {
            const split = team.splits.find(s => s.section == section);
            if(split) {
                split.note = value;
                // OPãªã©ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã€åŒºé–“é †ä½ã®å†æç”»ãŒå¿…è¦
                generateSectionRanking();
            }
        }
        
        // å†æç”»
        generateResultTable();
        generateSectionRanking();
    }

    function recalculateTeamTimes(team) {
        let total = 0;
        team.splits.sort((a,b) => a.section - b.section);
        team.splits.forEach(s => {
            total += s.netTime;
            s.finishTime = total;
        });
        team.finishTime = total;
    }

    // --- çµæœãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ (ç·¨é›†å¯èƒ½) ---
    function generateResultTable() {
        const table = document.getElementById('result-table');
        let html = `<thead><tr><th>é †ä½</th><th>ãƒãƒ¼ãƒ å</th><th>ç·åˆã‚¿ã‚¤ãƒ </th>`;
        for(let i=1; i<=config.sectionCount; i++) html += `<th>${i}åŒº</th>`;
        html += `</tr></thead><tbody>`;

        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 1;
            if (!b.finishTime) return -1;
            return a.finishTime - b.finishTime;
        });

        sortedTeams.forEach((t, rank) => {
            let totalTimeHtml = formatTimeDigit(t.finishTime);
            if (t.finishTime && isNewTotalRecord(t.finishTime)) {
                totalTimeHtml += '<span class="new-record-badge">å¤§ä¼šæ–°</span>';
            }

            html += `<tr>
                <td class="colored-rank" style="background-color:${t.color};">${t.finishTime ? rank + 1 : '-'}</td>
                <td style="text-align:left">${t.name}</td>
                <td style="font-weight:bold">${totalTimeHtml}</td>`;
            
            for(let i=1; i<=config.sectionCount; i++) {
                const split = t.splits.find(s => s.section === i);
                if(split) {
                    let mark = '';
                    if(split.isKuriage) mark = '<span style="color:red; font-size:0.8em">(ç¹°)</span>';
                    if (isNewSectionRecord(i, split.netTime)) mark += '<span class="new-record-badge">åŒºé–“æ–°</span>';
                    
                    // ç·¨é›†å¯èƒ½ã‚»ãƒ«
                    html += `<td>
                        <div contenteditable="true" onblur="updateResultData(${t.id}, 'time', ${i}, this.innerText)">${formatTimeDigit(split.netTime)}</div>
                        <div contenteditable="true" style="font-size:0.85em; color:#555;" onblur="updateResultData(${t.id}, 'name', ${i}, this.innerText)">${split.runner}</div>
                        <div contenteditable="true" style="font-size:0.7em; color:#888; border-top:1px dotted #ccc;" placeholder="å‚™è€ƒ" onblur="updateResultData(${t.id}, 'note', ${i}, this.innerText)">${split.note || ''}</div>
                        ${mark}
                    </td>`;
                } else {
                    html += `<td>-</td>`;
                }
            }
            html += `</tr>`;
        });
        html += `</tbody>`;
        table.innerHTML = html;
    }

    function generateSectionRanking() {
        const container = document.getElementById('section-ranking-container');
        container.innerHTML = "";

        for(let i=1; i<=config.sectionCount; i++) {
            let sectionData = [];
            teams.forEach(t => {
                const split = t.splits.find(s => s.section === i);
                if(split) {
                    // ã‚ªãƒ¼ãƒ—ãƒ³å‚åŠ ï¼ˆOP, å‚è€ƒ, ä»£ç†ï¼‰ã¯é™¤å¤–
                    const note = (split.note || "").toUpperCase();
                    if (!note.includes("OP") && !note.includes("å‚è€ƒ") && !note.includes("ä»£ç†")) {
                        sectionData.push({ teamName: t.name, color: t.color, runner: split.runner, netTime: split.netTime });
                    }
                }
            });
            sectionData.sort((a, b) => a.netTime - b.netTime);

            let html = `
            <div style="margin-bottom:20px; background:#f9f9f9; padding:10px; border-radius:5px;">
                <h4>${i}åŒº (${config.distances[i-1]||'?'}km)</h4>
                <table style="width:100%; margin-top:5px;">
                    <tr><th style="width:60px">é †ä½</th><th>é¸æ‰‹(ãƒãƒ¼ãƒ )</th><th>åŒºé–“ã‚¿ã‚¤ãƒ </th></tr>`;
            
            sectionData.forEach((d, idx) => {
                let timeHtml = formatTimeDigit(d.netTime);
                if (isNewSectionRecord(i, d.netTime)) timeHtml += '<span class="new-record-badge">åŒºé–“æ–°</span>';
                html += `<tr>
                    <td class="colored-rank" style="background-color:${d.color};">${idx+1}</td>
                    <td style="text-align:left">${d.runner} <small>(${d.teamName})</small></td>
                    <td>${timeHtml}</td>
                </tr>`;
            });
            html += `</table></div>`;
            container.innerHTML += html;
        }
    }

    function downloadExcel() {
        let csvContent = "\ufeff"; 
        // åˆ—ã‚’è¿½åŠ ï¼šãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼
        let header = ["é †ä½", "ãƒãƒ¼ãƒ å", "ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼", "ç·åˆã‚¿ã‚¤ãƒ "];
        for(let i=1; i<=config.sectionCount; i++) header.push(`${i}åŒºèµ°è€…`, `${i}åŒºé–“ã‚¿ã‚¤ãƒ `, `${i}åŒºé€šé`, "å‚™è€ƒ");
        csvContent += header.join(",") + "\n";

        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 1;
            if (!b.finishTime) return -1;
            return a.finishTime - b.finishTime;
        });

        sortedTeams.forEach((t, rank) => {
            let row = [ 
                t.finishTime ? rank + 1 : '-', 
                `"${t.name}"`, 
                t.color, 
                formatTimeDigit(t.finishTime) // æ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›
            ];
            for(let i=1; i<=config.sectionCount; i++) {
                const split = t.splits.find(s => s.section === i);
                if(split) {
                    let note = split.note || "";
                    if (split.isKuriage) {
                        note += split.kuriageType === 'all' ? " (ä¸€æ–‰ç¹°)" : " (é…å»¶ç¹°)";
                    }
                    if (isNewSectionRecord(i, split.netTime)) note += " åŒºé–“æ–°";
                    
                    row.push(
                        `"${split.runner}"`, 
                        formatTimeDigit(split.netTime), 
                        formatTimeDigit(split.finishTime), 
                        `"${note.trim()}"`
                    );
                } else { row.push("-", "-", "-", "-"); }
            }
            csvContent += row.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é§…ä¼çµæœ_${config.meta.title}_${new Date().toLocaleTimeString().replace(/:/g,'-')}.csv`;
        link.click();
    }

    function openCertificatePreview() {
        document.body.classList.add('print-mode');
        const wrapper = document.getElementById('certificates-wrapper');
        wrapper.innerHTML = "";

        const dateObj = new Date(config.meta.date);
        let fiscalYear = dateObj.getFullYear();
        if(dateObj.getMonth() + 1 < 4) fiscalYear -= 1;
        const reiwaYear = fiscalYear - 2018;
        const yearStr = reiwaYear === 1 ? "å…ƒ" : reiwaYear;
        const reiwaDateStr = `ä»¤å’Œ${yearStr}å¹´${dateObj.getMonth()+1}æœˆ${dateObj.getDate()}æ—¥`;

        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 999999999; 
            if (!b.finishTime) return -999999999;
            return a.finishTime - b.finishTime;
        });

        const createCertHTML = (title, teamName, sectionInfo, runnerName, recordText, mainText) => `
            <div class="certificate-page">
                <div class="cert-frame"></div>
                <div class="cert-layer">
                    <div class="cert-title" contenteditable="true">${title}</div>
                    <div class="cert-header-area">
                        <div class="cert-team-info" contenteditable="true">${teamName}</div>
                        <div class="cert-runner-line">
                            <span class="cert-section-info" contenteditable="true">${sectionInfo}</span>
                            <span class="cert-runner-name" contenteditable="true">${runnerName} æ®¿</span>
                        </div>
                    </div>
                    <div class="cert-record-area" contenteditable="true">${recordText}</div>
                    <div class="cert-text" contenteditable="true">${mainText}</div>
                    <div class="cert-footer">
                        <div class="cert-date" contenteditable="true">${reiwaDateStr}</div>
                        <div class="cert-org" contenteditable="true">${config.meta.org}</div>
                        <div class="cert-signer">
                            <span class="cert-signer-job" contenteditable="true">${config.meta.job}</span>
                            <span class="cert-signer-name" contenteditable="true">${config.meta.rep}</span>
                        </div>
                    </div>
                </div>
            </div>`;

        const commonText = `ã‚ãªãŸã¯ä»¤å’Œ${yearStr}å¹´åº¦${config.meta.title}ã«ãŠã„ã¦ã‚ˆãå¥®é—˜ã•ã‚Œé ­æ›¸ã®æˆç¸¾ã‚’åã‚ã‚‰ã‚Œã¾ã—ãŸã®ã§ãã®æ „èª‰ã‚’è®ƒãˆã“ã‚Œã‚’è³ã—ã¾ã™`;

        teams.forEach(team => {
            const rank = sortedTeams.findIndex(t => t.id === team.id) + 1;
            let rankText = team.finishTime ? `ï¼ˆç·åˆ${rank}ä½ï¼‰` : `ï¼ˆè¨˜éŒ²ãªã—ï¼‰`;
            if (team.finishTime && isNewTotalRecord(team.finishTime)) rankText += `<span class="cert-new-record-mark">(å¤§ä¼šæ–°)</span>`;

            team.splits.forEach(split => {
                const sectionSplits = [];
                teams.forEach(t => {
                    const s = t.splits.find(sp => sp.section === split.section);
                    // OPå‚åŠ ã¯é †ä½è¨ˆç®—ã‹ã‚‰é™¤å¤–
                    const note = (s.note || "").toUpperCase();
                    if(s && !note.includes("OP") && !note.includes("å‚è€ƒ") && !note.includes("ä»£ç†")) {
                        sectionSplits.push(s);
                    }
                });
                sectionSplits.sort((a, b) => a.netTime - b.netTime);
                
                // è‡ªèº«ã®åŒºé–“é †ä½ï¼ˆOPãªã‚‰é †ä½ãªã—ï¼‰
                let recordDisplay = `è¨˜éŒ² ${formatTime(split.netTime)}`;
                const myNote = (split.note || "").toUpperCase();
                if(!myNote.includes("OP") && !myNote.includes("å‚è€ƒ") && !myNote.includes("ä»£ç†")) {
                    const sectionRank = sectionSplits.findIndex(s => s === split) + 1;
                    recordDisplay += ` (åŒºé–“${sectionRank}ä½)`;
                    if (isNewSectionRecord(split.section, split.netTime)) recordDisplay += `<span class="cert-new-record-mark">(åŒºé–“æ–°)</span>`;
                } else {
                    recordDisplay += ` (å‚è€ƒè¨˜éŒ²)`;
                }

                wrapper.insertAdjacentHTML('beforeend', createCertHTML("è¨˜éŒ²è¨¼", `${team.name}${rankText}`, `ç¬¬${split.section}åŒº`, split.runner, recordDisplay, commonText));
            });
        });

        document.getElementById('print-preview-modal').style.display = 'block';
        adjustFontSizes();
    }

    function adjustFontSizes() {
        const names = document.querySelectorAll('.cert-runner-name');
        names.forEach(nameEl => {
            const line = nameEl.parentNode;
            const sectionInfo = line.querySelector('.cert-section-info');
            const maxWidth = line.clientWidth - sectionInfo.offsetWidth - 50; 
            let fontSize = 4.2; 
            nameEl.style.fontSize = fontSize + 'em';
            while (nameEl.scrollWidth > maxWidth && fontSize > 1.0) {
                fontSize -= 0.1;
                nameEl.style.fontSize = fontSize + 'em';
            }
        });
    }

    function closeCertificatePreview() {
        document.body.classList.remove('print-mode');
        document.getElementById('print-preview-modal').style.display = 'none';
    }
</script>
</body>
</html>
