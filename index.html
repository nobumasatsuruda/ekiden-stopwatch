<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é§…ä¼è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ  Pro (è¨˜éŒ²è¨¼æ©Ÿèƒ½ä»˜)</title>
    <style>
        :root {
            --primary-color: #333;
            --accent-color: #0056b3;
            --bg-color: #f4f4f9;
            --card-bg: #fff;
            --kuriage-color: #d9534f;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        h1, h2, h3 { text-align: center; margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
        .hidden { display: none !important; }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-outline { background-color: transparent; border: 2px solid #666; color: #666; }

        /* é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ */
        #toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #toast-notification.show { opacity: 1; }

        /* è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚¨ãƒªã‚¢ */
        .file-controls {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed #999;
        }

        /* å¤§ä¼šæƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .meta-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .meta-info-grid label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .meta-info-grid input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* è¨­å®šç”»é¢ */
        #setup-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .team-setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .team-input-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background: #fafafa;
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªé¸æ‰‹ãƒªã‚¹ãƒˆ */
        .runner-sort-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        .runner-sort-item {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .drag-handle {
            cursor: move;
            padding: 0 10px;
            font-size: 1.2em;
            color: #888;
            user-select: none;
        }
        .runner-section-num {
            font-weight: bold;
            margin-right: 8px;
            width: 30px;
            text-align: center;
            font-size: 0.8em;
            background: #eee;
            border-radius: 3px;
        }
        .runner-name-input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* ãƒ¬ãƒ¼ã‚¹ç”»é¢ */
        #timer-display {
            font-size: 4em;
            font-family: 'Courier New', monospace;
            text-align: center;
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .race-grid {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 20px;
            min-height: 400px;
        }

        .team-column {
            flex: 0 0 240px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 10px solid #ccc;
            position: relative;
        }

        .team-header { padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; }
        .current-runner { padding: 15px; text-align: center; background: #eef; flex-shrink: 0; }
        .current-runner h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #666; }
        .current-runner p { margin: 0; font-size: 1.2em; font-weight: bold; }

        .btn-tasuki { width: 100%; padding: 15px; font-size: 1.2em; margin:0; }
        
        .history-list {
            flex-grow: 1;
            padding: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            overflow-y: auto;
            background: #fff;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }
        .history-item span:first-child { font-weight: bold; }
        .kuriage-mark { color: red; font-weight: bold; }

        /* ç¹°ã‚Šä¸Šã’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        #kuriage-menu {
            background: #fff3cd; 
            padding: 15px; 
            text-align: center; 
            border: 2px solid #ffeeba; 
            margin-bottom: 20px;
            border-radius: 8px;
        }

        /* é…ã‚Œèµ°è€…ã‚¨ãƒªã‚¢ */
        #straggler-zone {
            margin-top: 30px;
            padding: 20px;
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 8px;
        }
        .straggler-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .straggler-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 5px solid #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            width: 200px;
            text-align: center;
        }

        /* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #f2f2f2; }
        
        .colored-rank {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: bold;
            font-size: 1.1em;
        }

        /* --- è¨˜éŒ²è¨¼ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ --- */
        #print-preview-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }
        #print-preview-content {
            background: #555;
            min-height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .preview-controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2001;
            display: flex;
            gap: 10px;
        }

        /* è¨˜éŒ²è¨¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆA4ç¸¦ï¼‰ */
        .certificate-page {
            width: 210mm; 
            height: 297mm;
            background: white;
            position: relative;
            box-sizing: border-box;
            padding: 10mm 15mm; 
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: "Serif", "Mincho", "Hiragino Mincho ProN", serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            page-break-after: always;
            page-break-inside: avoid;
        }

        [contenteditable]:hover {
            background-color: rgba(255, 255, 0, 0.1);
            outline: 1px dashed #ccc;
            cursor: text;
        }
        [contenteditable]:focus {
            background-color: rgba(255, 255, 0, 0.2);
            outline: none;
        }
        
        .cert-frame {
            position: absolute;
            top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
            border: 2px solid #b8860b;
            outline: 4px double #b8860b;
            outline-offset: 4px;
            z-index: 0;
            pointer-events: none;
        }

        .cert-layer { z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .cert-title { 
            font-size: 5em; 
            margin-top: 15mm;
            margin-bottom: 10mm; 
            letter-spacing: 0.3em; 
            font-weight: bold; 
            line-height: 1.0;
        }

        /* åå‰ãƒ»ãƒãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .cert-header-area {
            width: 90%;
            margin-bottom: 10mm;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* å·¦å¯„ã› */
        }

        .cert-team-info {
            font-size: 2.2em; /* ãƒãƒ¼ãƒ åã‚µã‚¤ã‚º */
            font-weight: bold;
            margin-bottom: 5px;
            width: 100%;
            text-align: left;
            margin-left: 20px;
        }

        .cert-runner-line {
            width: 100%;
            text-align: center;
            border-bottom: 1px solid transparent; 
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 20px;
            overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
        }

        .cert-section-info {
            font-size: 2.2em; /* ãƒãƒ¼ãƒ åã¨åŒã˜ã‚µã‚¤ã‚º */
            font-weight: bold;
            white-space: nowrap; /* æ”¹è¡Œç¦æ­¢ */
        }

        .cert-runner-name {
            font-size: 4.2em; 
            font-weight: bold;
            white-space: nowrap; /* æ”¹è¡Œç¦æ­¢ */
        }
        
        /* è¨˜éŒ² */
        .cert-record-area {
            font-size: 2.5em; 
            margin-top: 5mm;
            margin-bottom: 10mm;
            text-align: center;
            font-weight: bold;
        }

        /* æœ¬æ–‡ */
        .cert-text { 
            font-size: 2em; 
            margin: 0 5mm; 
            line-height: 1.8; 
            text-align: justify; 
            width: 90%;
            letter-spacing: 0.05em;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .cert-footer { 
            width: 90%; 
            margin-top: auto; 
            margin-bottom: 15mm;
            display: flex; 
            flex-direction: column; 
            align-items: center; /* ä¸­å¤®æƒãˆ */
            gap: 15px;
        }
        
        .cert-date { 
            width: 100%;
            font-size: 1.6em; 
            text-align: left; /* å·¦å¯„ã› */
            margin-bottom: 10px;
        }

        .cert-org {
            font-size: 2.0em;
            font-weight: bold;
            text-align: center;
        }

        .cert-signer { 
            text-align: center; 
            font-size: 2.2em; 
        }
        .cert-signer-job { font-size: 0.6em; margin-right: 10px; }
        .cert-signer-name { font-weight: bold; letter-spacing: 0.1em; }

        /* å°åˆ·è¨­å®šã®æ”¹è‰¯ */
        @media print {
            /* å…±é€š: ãƒœã‚¿ãƒ³ã‚„æ“ä½œã‚¨ãƒªã‚¢ã€é€šçŸ¥ã¯éš ã™ */
            .btn, .file-controls, .preview-controls, #toast-notification { display: none !important; }

            /* --- ãƒ‘ã‚¿ãƒ¼ãƒ³A: è¨˜éŒ²è¨¼å°åˆ·ãƒ¢ãƒ¼ãƒ‰ (bodyã«.print-modeãŒã‚ã‚‹æ™‚) --- */
            body.print-mode .container { display: none !important; } /* é€šå¸¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™ */
            body.print-mode #print-preview-modal {
                display: block !important;
                position: absolute; left: 0; top: 0; width: 100%;
                background: none;
                z-index: 9999;
            }
            body.print-mode .certificate-page {
                box-shadow: none; margin: 0; page-break-after: always;
            }

            /* --- ãƒ‘ã‚¿ãƒ¼ãƒ³B: é€šå¸¸å°åˆ·ãƒ¢ãƒ¼ãƒ‰ (bodyã«.print-modeãŒãªã„æ™‚) --- */
            body:not(.print-mode) #print-preview-modal { display: none !important; } /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã™ */
            body:not(.print-mode) .container { width: 100%; max-width: 100%; display: block !important;}
            body:not(.print-mode) table { width: 100%; border: 1px solid #000; page-break-inside: auto; }
            body:not(.print-mode) tr { page-break-inside: avoid; page-break-after: auto; }
            
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
        }

    </style>
</head>
<body>

<div id="toast-notification">é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

<div class="container">
    <h1>ğŸ† é§…ä¼è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ  Pro</h1>

    <div id="setup-panel">
        <div class="file-controls">
            <h3>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div style="margin-bottom:10px;">
                <strong>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                <button class="btn btn-outline" onclick="downloadSettings()">è¨­å®šã‚’ä¿å­˜</button>
                <label class="btn btn-primary" style="display:inline-block; margin:5px;">
                    è¨­å®šã‚’èª­è¾¼
                    <input type="file" id="file-input" accept=".json" style="display:none" onchange="loadSettings(this)">
                </label>
            </div>
            <div style="border-top:1px dashed #ccc; padding-top:10px;">
                <strong>çµæœãƒ‡ãƒ¼ã‚¿:</strong>
                <label class="btn btn-warning" style="display:inline-block; margin:5px;">
                    çµæœCSVã‚’èª­è¾¼ (å¾©å…ƒ)
                    <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="loadResultCSV(this)">
                </label>
            </div>
        </div>

        <h2>å¤§ä¼šåŸºæœ¬è¨­å®š</h2>
        <div class="meta-info-grid">
            <div><label>å¤§ä¼šå</label><input type="text" id="meta-title" value="æ ¡å†…é§…ä¼å¤§ä¼š"></div>
            <div><label>é–‹å‚¬æ—¥æ™‚</label><input type="datetime-local" id="meta-date"></div>
            <div><label>ä¸»å‚¬å­¦æ ¡ãƒ»å›£ä½“å</label><input type="text" id="meta-org" value="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡ä¸­å­¦æ ¡"></div>
            <div><label>ä¸»å‚¬è€…å½¹è·</label><input type="text" id="meta-job" value="æ ¡é•·"></div>
            <div><label>ä¸»å‚¬è€…æ°å</label><input type="text" id="meta-rep" value="ã€‡ã€‡ ã€‡ã€‡"></div>
        </div>

        <div style="text-align:center; margin-bottom:15px; padding: 15px; background: #eee; border-radius:8px;">
            <label>åŒºé–“æ•°: <input type="number" id="section-count" value="5" min="1" max="20" style="width: 50px;"></label>
            <label style="margin-left: 20px;">ãƒãƒ¼ãƒ æ•°: <input type="number" id="team-count" value="3" min="1" max="20" style="width: 50px;"></label>
            <button class="btn btn-primary" onclick="generateSetupGrid()">ãƒãƒ¼ãƒ ãƒ»èµ°è€…å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ</button>
            <p style="font-size:0.8em; color:#666;">â€»ç”Ÿæˆå¾Œã€é¸æ‰‹ã®é †ç•ªã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§å…¥ã‚Œæ›¿ãˆå¯èƒ½ã§ã™ã€‚</p>
        </div>
        
        <div id="distance-setup" class="hidden" style="text-align:center; margin-bottom:15px;">
            <h3>åŒºé–“è·é›¢è¨­å®š (km)</h3>
            <div id="distance-inputs" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;"></div>
        </div>

        <div id="teams-setup" class="team-setup-grid"></div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-success" id="start-setup-btn" onclick="initializeRace()" disabled>è¨­å®šå®Œäº†ãƒ»ãƒ¬ãƒ¼ã‚¹ç”»é¢ã¸</button>
        </div>
    </div>

    <div id="race-panel" class="hidden">
        <h2 id="race-title-display"></h2>
        <div id="timer-display">00:00.00</div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <button class="btn btn-success" id="btn-start" onclick="startTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆ (å·ç ²)</button>
            <button class="btn btn-warning" id="btn-kuriage" onclick="toggleKuriageMenu()">ç¹°ã‚Šä¸Šã’å‡¦ç†...</button>
            <button class="btn btn-primary" onclick="finishRace()">å…¨è¨ˆæ¸¬çµ‚äº†ãƒ»çµæœå‡ºåŠ›</button>
        </div>

        <div id="kuriage-menu" class="hidden">
            <h3 style="color:var(--kuriage-color)">âš ï¸ ä¸€æ–‰ç¹°ã‚Šä¸Šã’ã‚¹ã‚¿ãƒ¼ãƒˆ</h3>
            <p>ç¾åœ¨èµ°è¡Œä¸­ã®èµ°è€…ã‚’ã€Œã¾ã ã‚³ãƒ¼ã‚¹ä¸Šã«ã„ã‚‹ã€çŠ¶æ…‹ã¨ã—ã¦æ®‹ã—ã€<br>æ¬¡ã®èµ°è€…ã‚’å¼·åˆ¶çš„ã«ã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã¾ã™ã€‚</p>
            <button class="btn btn-danger" onclick="executeKuriage()">å®Ÿè¡Œã™ã‚‹</button>
            <button class="btn" onclick="toggleKuriageMenu()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div class="race-grid" id="race-grid"></div>

        <div id="straggler-zone" class="hidden">
            <h3 style="margin-top:0;">â³ é…ã‚Œèµ°è€… åˆ°ç€å¾…ã¡</h3>
            <div id="straggler-list" class="straggler-grid"></div>
        </div>
    </div>

    <div id="result-panel" class="hidden" style="background: white; padding: 20px; margin-top: 20px;">
        <h2>ãƒ¬ãƒ¼ã‚¹çµæœ</h2>
        <div style="text-align:center;">
            <button class="btn btn-success" onclick="downloadExcel()">Excel(CSV)ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-warning" onclick="openCertificatePreview()">ğŸ–¨ï¸ è¨˜éŒ²è¨¼ã‚’ç™ºè¡Œ (ç·¨é›†ãƒ»å°åˆ·)</button>
            <button class="btn" onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
        </div>

        <h3 style="margin-top:20px; border-bottom:2px solid #ccc;">ç·åˆé †ä½</h3>
        <div style="overflow-x: auto;">
            <table id="result-table"></table>
        </div>

        <h3 style="margin-top:40px; border-bottom:2px solid #ccc;">åŒºé–“è³ãƒ»åŒºé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="section-ranking-container"></div>
    </div>
</div>

<div id="print-preview-modal">
    <div id="print-preview-content">
        <div class="preview-controls">
            <span style="align-self:center; font-weight:bold;">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†å¯èƒ½)</span>
            <button class="btn btn-success" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ã™ã‚‹</button>
            <button class="btn btn-danger" onclick="closeCertificatePreview()">é–‰ã˜ã‚‹</button>
        </div>
        <div id="certificates-wrapper">
            </div>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let config = {
        meta: { title: "", date: "", org: "", job: "", rep: "" },
        sectionCount: 5,
        teamCount: 3,
        distances: []
    };
    
    let teams = []; 
    let pendingStragglers = []; 

    let raceState = {
        startTime: null,
        timerInterval: null,
        isRunning: false
    };

    // åˆæœŸåŒ–ï¼šæ—¥ä»˜å…¥åŠ›ã‚’ç¾åœ¨æ—¥æ™‚ã«
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('meta-date').value = now.toISOString().slice(0,16);
    });

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function formatTimeDigit(ms) { // è¨ˆæ¸¬ãƒ»ç”»é¢ãƒ»CSVç”¨ (åˆ†:ç§’.1/100)
        if(!ms && ms !== 0) return "-";
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centis = Math.floor((ms % 1000) / 10);
        return `${pad(minutes)}:${pad(seconds)}.${pad(centis)}`;
    }

    function formatTime(ms) { // è¨˜éŒ²è¨¼ç”¨ (åˆ†ãƒ»ç§’ãƒ»1/100)
        if(!ms && ms !== 0) return "-";
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centis = Math.floor((ms % 1000) / 10);
        return `${minutes}åˆ†${pad(seconds)}ç§’${pad(centis)}`;
    }

    function parseTimeStr(str) {
        // "MM:SS.cc" ã¾ãŸã¯ "MM:SS" ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒŸãƒªç§’ã«
        if (!str || str === "-") return null;
        const parts = str.split(':');
        if(parts.length < 2) return null;
        const min = parseInt(parts[0], 10);
        const secParts = parts[1].split('.');
        const sec = parseInt(secParts[0], 10);
        const centi = secParts.length > 1 ? parseInt(secParts[1], 10) : 0;
        return (min * 60000) + (sec * 1000) + (centi * 10);
    }

    function pad(n) { return n < 10 ? '0'+n : n; }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
        return color;
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // --- è¨­å®šç”»é¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    function generateSetupGrid() {
        const sc = parseInt(document.getElementById('section-count').value);
        const tc = parseInt(document.getElementById('team-count').value);
        if(sc < 1 || tc < 1) return alert("æ•°å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");

        config.sectionCount = sc;
        config.teamCount = tc;

        // è·é›¢è¨­å®š
        const distContainer = document.getElementById('distance-inputs');
        distContainer.innerHTML = '';
        document.getElementById('distance-setup').classList.remove('hidden');
        for(let i=1; i<=sc; i++){
            let val = config.distances[i-1] || 3;
            distContainer.innerHTML += `<div>${i}åŒº: <input type="number" class="dist-val" style="width:50px" value="${val}">km</div>`;
        }

        // ãƒãƒ¼ãƒ è¨­å®š
        const teamsContainer = document.getElementById('teams-setup');
        teamsContainer.innerHTML = '';
        
        for(let i=1; i<=tc; i++){
            let currentTeam = teams[i-1] || { name: `ãƒãƒ¼ãƒ ${i}`, color: getRandomColor(), runners: [] };
            let runnerListHtml = '';
            for(let s=1; s<=sc; s++){
                let rName = currentTeam.runners[s-1] || "";
                runnerListHtml += `
                    <li class="runner-sort-item" draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <span class="drag-handle">â‰¡</span>
                        <span class="runner-section-num">${s}åŒº</span>
                        <input type="text" class="runner-name-input" value="${rName}" placeholder="èµ°è€…å">
                    </li>`;
            }

            const html = `
            <div class="team-input-card" id="team-setup-${i}">
                <h3 style="margin:5px 0;">Team ${i}</h3>
                <label>ãƒãƒ¼ãƒ å: <input type="text" class="team-name" value="${currentTeam.name}"></label><br>
                <label>ã‚¿ã‚¹ã‚­è‰²: <input type="color" class="team-color" value="${currentTeam.color}"></label>
                <div style="margin-top:10px;">
                    <strong>èµ°è€…é † (ãƒ‰ãƒ©ãƒƒã‚°ã§å…¥æ›¿å¯):</strong>
                    <ul class="runner-sort-list" id="runner-list-${i}">
                        ${runnerListHtml}
                    </ul>
                </div>
            </div>`;
            teamsContainer.insertAdjacentHTML('beforeend', html);
        }

        document.getElementById('start-setup-btn').disabled = false;
        document.getElementById('start-setup-btn').textContent = "è¨­å®šå®Œäº†ãƒ»ãƒ¬ãƒ¼ã‚¹ç”»é¢ã¸";
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—åˆ¶å¾¡ ---
    let draggedItem = null;
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) {
        draggedItem = ev.target.closest('li');
        ev.dataTransfer.effectAllowed = "move";
    }
    function drop(ev) {
        ev.preventDefault();
        const targetItem = ev.target.closest('li');
        if (draggedItem && targetItem && draggedItem !== targetItem && draggedItem.parentNode === targetItem.parentNode) {
            const list = draggedItem.parentNode;
            const items = Array.from(list.children);
            const fromIndex = items.indexOf(draggedItem);
            const toIndex = items.indexOf(targetItem);
            if (fromIndex < toIndex) {
                list.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                list.insertBefore(draggedItem, targetItem);
            }
            updateSectionLabels(list);
        }
    }
    function updateSectionLabels(listElement) {
        const items = listElement.querySelectorAll('.runner-sort-item');
        items.forEach((item, index) => {
            item.querySelector('.runner-section-num').textContent = `${index + 1}åŒº`;
        });
    }

    // --- è¨­å®šä¿å­˜ãƒ»èª­è¾¼ ---
    function getSettingsObject() {
        let dists = [];
        document.querySelectorAll('.dist-val').forEach(el => dists.push(el.value));
        
        let currentTeams = [];
        const container = document.getElementById('teams-setup');
        if(container.children.length === 0) return null;

        for(let i=1; i<=config.teamCount; i++){
            const card = document.getElementById(`team-setup-${i}`);
            const name = card.querySelector('.team-name').value;
            const color = card.querySelector('.team-color').value;
            const runners = [];
            card.querySelectorAll('.runner-name-input').forEach(inp => runners.push(inp.value));
            currentTeams.push({ name, color, runners });
        }

        const meta = {
            title: document.getElementById('meta-title').value,
            date: document.getElementById('meta-date').value,
            org: document.getElementById('meta-org').value,
            job: document.getElementById('meta-job').value,
            rep: document.getElementById('meta-rep').value
        };

        return { 
            meta: meta,
            sectionCount: config.sectionCount, 
            teamCount: config.teamCount, 
            distances: dists, 
            teamsData: currentTeams 
        };
    }

    function downloadSettings() {
        const data = getSettingsObject();
        if(!data) return alert("å…ˆã«å…¥åŠ›æ¬„ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„");
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "ekiden_settings.json";
        link.click();
    }

    function loadSettings(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                document.getElementById('section-count').value = data.sectionCount;
                document.getElementById('team-count').value = data.teamCount;
                
                if(data.meta) {
                    document.getElementById('meta-title').value = data.meta.title || "";
                    document.getElementById('meta-date').value = data.meta.date || "";
                    document.getElementById('meta-org').value = data.meta.org || "";
                    document.getElementById('meta-job').value = data.meta.job || "";
                    document.getElementById('meta-rep').value = data.meta.rep || "";
                }

                config.sectionCount = data.sectionCount;
                config.teamCount = data.teamCount;
                config.distances = data.distances;
                teams = data.teamsData.map(t => ({ name: t.name, color: t.color, runners: t.runners }));
                generateSetupGrid();
                showToast("è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            } catch(err) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err); }
        };
        reader.readAsText(file);
    }

    // --- CSVèª­ã¿è¾¼ã¿ (å¾©å…ƒ) ---
    function loadResultCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== "");

                // ä¿®æ­£ç‰ˆCSVãƒ‘ãƒ¼ã‚¹: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆå¼•ç”¨ç¬¦å†…ç„¡è¦–ï¼‰
                const rows = lines.map(line => {
                    return line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(col => {
                        return col.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                    });
                });

                if (rows.length < 2) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

                const header = rows[0];
                let sc = 0;
                header.forEach(h => { if (h.match(/\d+åŒºèµ°è€…/)) sc++; });

                if (sc === 0) return alert("æœ‰åŠ¹ãªé§…ä¼çµæœCSVã§ã¯ã‚ã‚Šã¾ã›ã‚“");

                config.sectionCount = sc;
                config.teamCount = rows.length - 1;
                document.getElementById('section-count').value = sc;
                document.getElementById('team-count').value = config.teamCount;

                teams = [];
                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i];
                    // CSVæ§‹é€ : Rank, TeamName, FinishTime, Runner1, Net1, Finish1, Note1...
                    const teamName = cols[1];
                    const finishTime = parseTimeStr(cols[2]);
                    
                    const runners = [];
                    const splits = [];

                    for (let s = 1; s <= sc; s++) {
                        const baseIdx = 3 + (s - 1) * 4;
                        const rName = cols[baseIdx] || "";
                        const netTimeStr = cols[baseIdx + 1];
                        const finishTimeStr = cols[baseIdx + 2];
                        const note = cols[baseIdx + 3] || "";

                        runners.push(rName);

                        if (netTimeStr && netTimeStr !== "-") {
                            splits.push({
                                section: s,
                                runner: rName,
                                netTime: parseTimeStr(netTimeStr),
                                finishTime: parseTimeStr(finishTimeStr),
                                isKuriage: note.includes("ç¹°ã‚Šä¸Šã’")
                            });
                        }
                    }

                    teams.push({
                        id: i - 1,
                        name: teamName,
                        color: getRandomColor(),
                        runners: runners,
                        currentSection: sc, 
                        splits: splits,
                        status: 'finished',
                        finishTime: finishTime
                    });
                }

                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('race-panel').classList.add('hidden'); 
                document.getElementById('result-panel').classList.remove('hidden');
                
                const meta = {
                    title: document.getElementById('meta-title').value,
                    date: document.getElementById('meta-date').value,
                    org: document.getElementById('meta-org').value,
                    job: document.getElementById('meta-job').value,
                    rep: document.getElementById('meta-rep').value
                };
                config.meta = meta;

                generateResultTable();
                generateSectionRanking();
                showToast("çµæœCSVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");

            } catch (err) {
                console.error(err);
                alert("CSVèª­è¾¼ã‚¨ãƒ©ãƒ¼: å½¢å¼ãŒä¸æ­£ã§ã™");
            }
        };
        reader.readAsText(file);
    }


    // --- ãƒ¬ãƒ¼ã‚¹åˆæœŸåŒ– ---
    function initializeRace() {
        const settings = getSettingsObject();
        config.meta = settings.meta;
        config.distances = settings.distances;
        
        teams = settings.teamsData.map((t, i) => ({
            id: i,
            name: t.name,
            color: t.color,
            runners: t.runners, 
            currentSection: 0, 
            splits: [], 
            status: 'ready'
        }));

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('race-panel').classList.remove('hidden');
        document.getElementById('race-title-display').textContent = config.meta.title; 
        renderRaceGrid();
    }

    // --- ãƒ¬ãƒ¼ã‚¹ç”»é¢æç”» ---
    function renderRaceGrid() {
        const grid = document.getElementById('race-grid');
        grid.innerHTML = '';

        teams.forEach((team, index) => {
            let currentRunnerName = "å¾…æ©Ÿä¸­";
            if (team.status === 'running') currentRunnerName = team.runners[team.currentSection] || "æœªç™»éŒ²";
            else if (team.status === 'finished') currentRunnerName = "ã‚´ãƒ¼ãƒ«";

            let btnDisabled = !raceState.isRunning || team.status === 'finished';
            let btnText = "ã‚¿ã‚¹ã‚­ã‚’æ¸¡ã™";
            if (team.currentSection === config.sectionCount - 1) btnText = "ã‚´ãƒ¼ãƒ«ï¼";
            if (team.status === 'finished') { btnText = "å®Œèµ°"; btnDisabled = true; }

            const div = document.createElement('div');
            div.className = 'team-column';
            div.style.borderTopColor = team.color;
            div.innerHTML = `
                <div class="team-header" style="background-color:${team.color}22">
                    <span style="font-size:1.1em">${team.name}</span>
                </div>
                <div class="current-runner" id="runner-box-${index}">
                    <h4 class="section-label" id="section-label-${index}">ç¾åœ¨èµ°è¡Œä¸­ (${team.status === 'finished' ? '-' : team.currentSection + 1}åŒº)</h4>
                    <p id="runner-name-${index}">${currentRunnerName}</p>
                </div>
                <div style="padding:10px;">
                    <button class="btn btn-primary btn-tasuki" 
                        id="btn-tasuki-${index}" 
                        onclick="passTasuki(${index})" 
                        ${btnDisabled ? 'disabled' : ''}
                        style="background-color:${team.color}; color: white; text-shadow:0 1px 2px rgba(0,0,0,0.5);">
                        ${btnText}
                    </button>
                </div>
                <div class="history-list" id="history-${index}"></div>
            `;
            grid.appendChild(div);
        });
    }

    function renderStragglers() {
        const zone = document.getElementById('straggler-zone');
        const list = document.getElementById('straggler-list');
        list.innerHTML = '';
        
        if (pendingStragglers.length === 0) { zone.classList.add('hidden'); return; }

        zone.classList.remove('hidden');
        pendingStragglers.forEach((ps, idx) => {
            const team = teams[ps.teamId];
            const div = document.createElement('div');
            div.className = 'straggler-card';
            div.style.borderLeftColor = team.color;
            div.innerHTML = `
                <strong>${team.name}</strong><br>
                <small>${ps.section}åŒº</small> <span style="font-weight:bold">${ps.runnerName}</span><br>
                <button class="btn btn-warning btn-sm" style="margin-top:5px; width:100%" 
                    onclick="stragglerArrive(${idx})">åˆ°ç€ (è¨ˆæ¸¬)</button>
            `;
            list.appendChild(div);
        });
    }

    // --- è¨ˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ ---
    function startTimer() {
        if(raceState.isRunning) return;
        raceState.startTime = Date.now();
        raceState.isRunning = true;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-start').textContent = "ãƒ¬ãƒ¼ã‚¹é€²è¡Œä¸­";
        
        teams.forEach((t, i) => { t.status = 'running'; t.currentSection = 0; updateTeamUI(i); });

        raceState.timerInterval = setInterval(() => {
            const diff = Date.now() - raceState.startTime;
            document.getElementById('timer-display').textContent = formatTimeDigit(diff);
        }, 10);
        document.querySelectorAll('.btn-tasuki').forEach(b => b.disabled = false);
    }

    function passTasuki(teamIndex) {
        const team = teams[teamIndex];
        if (team.status === 'finished') return;

        const now = Date.now();
        const finishTimeMs = now - raceState.startTime;
        
        if (team.currentSection === 0) team.sectionStartTime = 0;
        const netTime = finishTimeMs - (team.sectionStartTime || 0);
        
        team.splits.push({
            section: team.currentSection + 1,
            runner: team.runners[team.currentSection],
            startTime: team.sectionStartTime || 0,
            finishTime: finishTimeMs,
            netTime: netTime,
            isKuriage: false,
            isStraggler: false
        });

        advanceSection(teamIndex, finishTimeMs);
    }

    function advanceSection(teamIndex, nextStartTime) {
        const team = teams[teamIndex];
        if (team.currentSection < config.sectionCount - 1) {
            team.currentSection++;
            team.sectionStartTime = nextStartTime; 
        } else {
            team.status = 'finished';
            team.finishTime = nextStartTime; 
        }
        updateTeamUI(teamIndex);
        checkAllFinished();
    }

    function updateTeamUI(index) {
        const team = teams[index];
        const card = document.getElementById('race-grid').children[index];
        
        const sectionLabel = card.querySelector(`#section-label-${index}`);
        if(team.status === 'finished') {
            sectionLabel.textContent = "ç¾åœ¨èµ°è¡Œä¸­ (-)";
        } else {
            sectionLabel.textContent = `ç¾åœ¨èµ°è¡Œä¸­ (${team.currentSection + 1}åŒº)`;
        }

        const runnerNameEl = card.querySelector(`#runner-name-${index}`);
        if(team.status === 'finished') {
            runnerNameEl.textContent = "ã‚´ãƒ¼ãƒ«";
            runnerNameEl.style.color = "red";
        } else {
            runnerNameEl.textContent = team.runners[team.currentSection] || `èµ°è€…${team.currentSection+1}`;
            runnerNameEl.style.color = "black";
        }

        const historyList = card.querySelector(`#history-${index}`);
        historyList.innerHTML = ''; 
        [...team.splits].reverse().forEach(split => {
             const div = document.createElement('div');
             div.className = 'history-item';
             div.innerHTML = `
                <div>
                    <span>${split.section}åŒº ${split.runner}</span>
                    ${split.isKuriage ? '<span class="kuriage-mark">(ç¹°)</span>' : ''}
                </div>
                <div style="text-align:right">
                    <small>åŒºé–“: ${formatTimeDigit(split.netTime)}</small><br>
                    <span>é€šé: ${formatTimeDigit(split.finishTime)}</span>
                </div>
            `;
            historyList.appendChild(div);
        });

        const btn = card.querySelector(`#btn-tasuki-${index}`);
        if(team.status === 'finished') {
            btn.textContent = "å®Œèµ°";
            btn.disabled = true;
        } else if (team.currentSection === config.sectionCount - 1) {
            btn.textContent = "ã‚´ãƒ¼ãƒ«ï¼";
        } else {
            btn.textContent = "ã‚¿ã‚¹ã‚­ã‚’æ¸¡ã™";
        }
    }

    function toggleKuriageMenu() {
        document.getElementById('kuriage-menu').classList.toggle('hidden');
    }

    function executeKuriage() {
        if(!raceState.isRunning) return;
        const now = Date.now();
        const currentTimeMs = now - raceState.startTime;
        let minSec = 999;
        teams.forEach(t => { if(t.status === 'running' && t.currentSection < minSec) minSec = t.currentSection; });
        if(minSec === 999) { showToast("èµ°è¡Œä¸­ã®ãƒãƒ¼ãƒ ãªã—"); return; }

        let count = 0;
        teams.forEach((team, idx) => {
            if(team.status === 'running' && team.currentSection === minSec) {
                pendingStragglers.push({
                    teamId: idx,
                    section: team.currentSection + 1,
                    runnerName: team.runners[team.currentSection],
                    startTime: team.sectionStartTime || 0
                });

                if (team.currentSection < config.sectionCount - 1) {
                    team.currentSection++;
                    team.sectionStartTime = currentTimeMs; 
                } else {
                    team.status = 'finished';
                    team.finishTime = currentTimeMs; 
                }
                updateTeamUI(idx); 
                count++;
            }
        });

        toggleKuriageMenu();
        renderStragglers();
        showToast(`${count}ãƒãƒ¼ãƒ ã‚’ä¸€æ–‰ç¹°ã‚Šä¸Šã’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    }

    function stragglerArrive(psIndex) {
        const ps = pendingStragglers[psIndex];
        const team = teams[ps.teamId];
        const now = Date.now();
        const finishTimeMs = now - raceState.startTime;
        const netTime = finishTimeMs - ps.startTime;

        team.splits.push({
            section: ps.section,
            runner: ps.runnerName,
            startTime: ps.startTime,
            finishTime: finishTimeMs,
            netTime: netTime,
            isKuriage: true,
            isStraggler: true
        });
        team.splits.sort((a,b) => a.section - b.section);
        pendingStragglers.splice(psIndex, 1);
        renderStragglers();
        updateTeamUI(ps.teamId); 
        showToast(`${team.name} å‰èµ°è€…ãŒåˆ°ç€ã—ã¾ã—ãŸ`);
    }

    function checkAllFinished() {
        const allFinished = teams.every(t => t.status === 'finished');
        if(allFinished && pendingStragglers.length === 0) {
            clearInterval(raceState.timerInterval);
            document.getElementById('timer-display').style.color = "#fff";
            document.getElementById('timer-display').textContent += " (å…¨çµ‚äº†)";
            showToast("å…¨ãƒãƒ¼ãƒ ã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼");
            finishRace();
        }
    }

    function finishRace() {
        clearInterval(raceState.timerInterval);
        document.getElementById('race-panel').classList.add('hidden');
        document.getElementById('result-panel').classList.remove('hidden');
        generateResultTable();
        generateSectionRanking();
    }

    function generateResultTable() {
        const table = document.getElementById('result-table');
        let html = `<thead><tr><th>é †ä½</th><th>ãƒãƒ¼ãƒ å</th><th>ç·åˆã‚¿ã‚¤ãƒ </th>`;
        for(let i=1; i<=config.sectionCount; i++) html += `<th>${i}åŒº</th>`;
        html += `</tr></thead><tbody>`;

        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 1;
            if (!b.finishTime) return -1;
            return a.finishTime - b.finishTime;
        });

        sortedTeams.forEach((t, rank) => {
            html += `<tr>
                <td class="colored-rank" style="background-color:${t.color};">${t.finishTime ? rank + 1 : '-'}</td>
                <td style="text-align:left">${t.name}</td>
                <td style="font-weight:bold">${formatTimeDigit(t.finishTime)}</td>`;
            
            for(let i=1; i<=config.sectionCount; i++) {
                const split = t.splits.find(s => s.section === i);
                if(split) {
                    let mark = split.isKuriage ? '<span style="color:red; font-size:0.8em">(ç¹°)</span>' : '';
                    html += `<td><strong>${formatTimeDigit(split.netTime)}</strong><br><small style="color:#666">${split.runner}</small> ${mark}</td>`;
                } else {
                    html += `<td>-</td>`;
                }
            }
            html += `</tr>`;
        });
        html += `</tbody>`;
        table.innerHTML = html;
    }

    function generateSectionRanking() {
        const container = document.getElementById('section-ranking-container');
        container.innerHTML = "";

        for(let i=1; i<=config.sectionCount; i++) {
            let sectionData = [];
            teams.forEach(t => {
                const split = t.splits.find(s => s.section === i);
                if(split) sectionData.push({ teamName: t.name, color: t.color, runner: split.runner, netTime: split.netTime });
            });
            sectionData.sort((a, b) => a.netTime - b.netTime);

            let html = `
            <div style="margin-bottom:20px; background:#f9f9f9; padding:10px; border-radius:5px;">
                <h4>${i}åŒº (${config.distances[i-1]||'?'}km)</h4>
                <table style="width:100%; margin-top:5px;">
                    <tr><th style="width:60px">é †ä½</th><th>é¸æ‰‹(ãƒãƒ¼ãƒ )</th><th>åŒºé–“ã‚¿ã‚¤ãƒ </th></tr>`;
            
            sectionData.forEach((d, idx) => {
                html += `<tr>
                    <td class="colored-rank" style="background-color:${d.color};">${idx+1}</td>
                    <td style="text-align:left">${d.runner} <small>(${d.teamName})</small></td>
                    <td>${formatTimeDigit(d.netTime)}</td>
                </tr>`;
            });
            html += `</table></div>`;
            container.innerHTML += html;
        }
    }

    function downloadExcel() {
        let csvContent = "\ufeff"; 
        let header = ["é †ä½", "ãƒãƒ¼ãƒ å", "ç·åˆã‚¿ã‚¤ãƒ "];
        for(let i=1; i<=config.sectionCount; i++) header.push(`${i}åŒºèµ°è€…`, `${i}åŒºé–“ã‚¿ã‚¤ãƒ `, `${i}åŒºé€šé`, "å‚™è€ƒ");
        csvContent += header.join(",") + "\n";
        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 1;
            if (!b.finishTime) return -1;
            return a.finishTime - b.finishTime;
        });

        sortedTeams.forEach((t, rank) => {
            let row = [ t.finishTime ? rank + 1 : '-', `"${t.name}"`, formatTimeDigit(t.finishTime) ];
            for(let i=1; i<=config.sectionCount; i++) {
                const split = t.splits.find(s => s.section === i);
                if(split) {
                    let note = split.isKuriage ? "ç¹°ã‚Šä¸Šã’" : "";
                    row.push(`"${split.runner}"`, formatTimeDigit(split.netTime), formatTimeDigit(split.finishTime), note);
                } else { row.push("-", "-", "-", "-"); }
            }
            csvContent += row.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é§…ä¼çµæœ_${config.meta.title}_${new Date().toLocaleTimeString().replace(/:/g,'-')}.csv`;
        link.click();
    }

    // --- è¨˜éŒ²è¨¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å°åˆ·æ©Ÿèƒ½ ---
    function openCertificatePreview() {
        // å°åˆ·ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        document.body.classList.add('print-mode');

        const wrapper = document.getElementById('certificates-wrapper');
        wrapper.innerHTML = "";

        const dateObj = new Date(config.meta.date);
        let fiscalYear = dateObj.getFullYear();
        if(dateObj.getMonth() + 1 < 4) fiscalYear -= 1;
        const reiwaYear = fiscalYear - 2018;
        const yearStr = reiwaYear === 1 ? "å…ƒ" : reiwaYear;
        const reiwaDateStr = `ä»¤å’Œ${yearStr}å¹´${dateObj.getMonth()+1}æœˆ${dateObj.getDate()}æ—¥`;

        let sortedTeams = [...teams].sort((a, b) => {
            if (!a.finishTime) return 999999999; 
            if (!b.finishTime) return -999999999;
            return a.finishTime - b.finishTime;
        });

        const createCertHTML = (title, teamName, sectionInfo, runnerName, recordText, mainText) => `
            <div class="certificate-page">
                <div class="cert-frame"></div>
                <div class="cert-layer">
                    <div class="cert-title" contenteditable="true">${title}</div>
                    
                    <div class="cert-header-area">
                        <div class="cert-team-info" contenteditable="true">${teamName}</div>
                        <div class="cert-runner-line">
                            <span class="cert-section-info" contenteditable="true">${sectionInfo}</span>
                            <span class="cert-runner-name" contenteditable="true">${runnerName} æ®¿</span>
                        </div>
                    </div>
                    
                    <div class="cert-record-area" contenteditable="true">${recordText}</div>
                    <div class="cert-text" contenteditable="true">${mainText}</div>
                    
                    <div class="cert-footer">
                        <div class="cert-date" contenteditable="true">${reiwaDateStr}</div>
                        <div class="cert-org" contenteditable="true">${config.meta.org}</div>
                        <div class="cert-signer">
                            <span class="cert-signer-job" contenteditable="true">${config.meta.job}</span>
                            <span class="cert-signer-name" contenteditable="true">${config.meta.rep}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const commonText = `ã‚ãªãŸã¯ä»¤å’Œ${yearStr}å¹´åº¦${config.meta.title}ã«ãŠã„ã¦ã‚ˆãå¥®é—˜ã•ã‚Œé ­æ›¸ã®æˆç¸¾ã‚’åã‚ã‚‰ã‚Œã¾ã—ãŸã®ã§ãã®æ „èª‰ã‚’è®ƒãˆã“ã‚Œã‚’è³ã—ã¾ã™`;

        teams.forEach(team => {
            const rank = sortedTeams.findIndex(t => t.id === team.id) + 1;
            const rankText = team.finishTime ? `ï¼ˆç·åˆ${rank}ä½ï¼‰` : `ï¼ˆè¨˜éŒ²ãªã—ï¼‰`;
            
            team.splits.forEach(split => {
                const sectionSplits = [];
                teams.forEach(t => {
                    const s = t.splits.find(sp => sp.section === split.section);
                    if(s) sectionSplits.push(s);
                });
                sectionSplits.sort((a, b) => a.netTime - b.netTime);
                const sectionRank = sectionSplits.findIndex(s => s === split) + 1;

                wrapper.insertAdjacentHTML('beforeend', createCertHTML(
                    "è¨˜éŒ²è¨¼", 
                    `${team.name}${rankText}`, 
                    `ç¬¬${split.section}åŒº`, 
                    `${split.runner}`, 
                    `è¨˜éŒ² ${formatTime(split.netTime)} (åŒºé–“${sectionRank}ä½)`, 
                    commonText 
                ));
            });
        });

        document.getElementById('print-preview-modal').style.display = 'block';
        
        // é¸æ‰‹åã®è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´
        adjustFontSizes();
    }

    function adjustFontSizes() {
        const names = document.querySelectorAll('.cert-runner-name');
        names.forEach(nameEl => {
            const line = nameEl.parentNode;
            const sectionInfo = line.querySelector('.cert-section-info');
            // åå‰ã‚¨ãƒªã‚¢ã®è¨±å®¹å¹…è¨ˆç®—
            const maxWidth = line.clientWidth - sectionInfo.offsetWidth - 50; 
            
            let fontSize = 4.2; // åˆæœŸã‚µã‚¤ã‚º
            nameEl.style.fontSize = fontSize + 'em';
            
            while (nameEl.scrollWidth > maxWidth && fontSize > 1.0) {
                fontSize -= 0.1;
                nameEl.style.fontSize = fontSize + 'em';
            }
        });
    }

    function closeCertificatePreview() {
        // å°åˆ·ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        document.body.classList.remove('print-mode');
        document.getElementById('print-preview-modal').style.display = 'none';
    }
</script>
</body>
</html>
